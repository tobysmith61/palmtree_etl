{% extends "admin/change_form.html" %}

{% block submit_buttons_bottom %}
    {{ block.super }}
    {% if not original %}
        <input type="submit"
               value="Save & Create SFTP"
               name="_create_sftp"
               class="default">
    {% endif %}
{% endblock %}


{% block after_related_objects %}

{% if original %}

<div class="module aligned">
    <h2>Drop Zone Files</h2>

    <table style="width:100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th style="text-align:left;">Folder / File</th>
                <th style="text-align:left;">Size</th>
                <th style="text-align:left;">Last Modified</th>
            </tr>
        </thead>
        <tbody id="dropzone-file-list">
            <tr><td colspan="3">Loading...</td></tr>
        </tbody>
    </table>
</div>

<script>
(function() {
    const apiUrl = "{% url 'tenants:dropzone_files_api' original.pk %}";
    const tableBody = document.getElementById("dropzone-file-list");

    function formatSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024)
            return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
    }

    async function loadFiles() {
        try {
            const response = await fetch(apiUrl);
            const data = await response.json();

            tableBody.innerHTML = "";

            if (!data.files || data.files.length === 0) {
                tableBody.innerHTML =
                    "<tr><td colspan='3'>No files found</td></tr>";
                return;
            }

            function getRowColor(filePath) {
                if (filePath.includes('/drop/')) return 'black';
                if (filePath.includes('/ready/')) return 'orange';
                if (filePath.includes('/processed/')) return 'green';
                if (filePath.includes('/failed/')) return 'red';
                return 'black'; // default
            }
            
            data.files.forEach(file => {
                const row = document.createElement("tr");
                row.style.color = getRowColor(file.path);  // <-- this sets the text color

                row.innerHTML = `
                    <td>${file.path}</td>
                    <td>${formatSize(file.size)}</td>
                    <td>${file.modified}</td>
                `;

                tableBody.appendChild(row);
            });

        } catch (err) {
            tableBody.innerHTML =
                "<tr><td colspan='3'>Error loading files</td></tr>";
        }
    }

    

    loadFiles();
    setInterval(loadFiles, 5000);
})();
</script>

{% endif %}

{{ block.super }}

{% endblock %}